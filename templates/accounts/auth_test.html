<!-- templates/accounts/auth_test.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  {% load i18n %}
  <title>{% trans "Auth Test" %}</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    form { margin-bottom: 2rem; padding: 1rem; border: 1px solid #ccc; }
    input { display: block; margin: 0.5rem 0; padding: 0.5rem; width: 100%; }
    button { padding: 0.5rem 1rem; }
    .response { background: #f9f9f9; padding: 1rem; margin-top: 1rem; white-space: pre-wrap; }
  </style>
  <script>
    // در شروع صفحه، همیشه توکن‌ها رو از localStorage بخون
    let accessToken = localStorage.getItem("access");
    let refreshToken = localStorage.getItem("refresh");
  
    async function apiRequest(url, method="GET", body=null, auth=true) {
      const headers = {"Content-Type": "application/json"};
      if (auth && accessToken) {
        headers["Authorization"] = "Bearer " + accessToken;
      }
      const res = await fetch(url, {method, headers, body: body ? JSON.stringify(body) : null});
      const text = await res.text();
      return text;
    }
  
    // 🟢 Login
    async function loginUser(e) {
      e.preventDefault();
      const username = document.getElementById("login-username").value;
      const password = document.getElementById("login-password").value;
  
      const res = await fetch("/api/accounts/auth/login/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({username, password})
      });
  
      const data = await res.json();
  
      if (data.access && data.refresh) {
        // ذخیره توکن‌ها در localStorage
        localStorage.setItem("access", data.access);
        localStorage.setItem("refresh", data.refresh);
  
        // آپدیت متغیرهای حافظه
        accessToken = data.access;
        refreshToken = data.refresh;
  
        document.getElementById("login-response").textContent = "✅ Logged in!";
      } else {
        document.getElementById("login-response").textContent = "❌ Login failed: " + JSON.stringify(data);
      }
    }
  
    // 🟢 Logout
    async function logoutUser() {
      const res = await apiRequest("/api/accounts/auth/logout/", "POST", {refresh: refreshToken});
      document.getElementById("logout-response").textContent = res;
  
      // پاک کردن توکن‌ها از localStorage
      localStorage.removeItem("access");
      localStorage.removeItem("refresh");
  
      accessToken = null;
      refreshToken = null;
    }
  
    // 🟢 تست پروفایل
    async function getProfile() {
      const res = await apiRequest("/api/accounts/me/");
      document.getElementById("profile-response").textContent = res;
    }
  </script>
</head>
<body>
  <h1>{% trans "Auth Test Page" %}</h1>

  <form onsubmit="registerUser(event)">
    <h2>{% trans "Register" %}</h2>
    <input id="reg-username" placeholder="{% trans "Username" %}" required>
    <input id="reg-email" placeholder="{% trans "Email" %}" type="email" required>
    <input id="reg-password" placeholder="{% trans "Password" %}" type="password" required>
    <button type="submit">{% trans "Register" %}</button>
    <div id="register-response" class="response"></div>
  </form>

  <form onsubmit="loginUser(event)">
    <h2>{% trans "Login" %}</h2>
    <input id="login-username" placeholder="{% trans "Username" %}" required>
    <input id="login-password" placeholder="{% trans "Password" %}" type="password" required>
    <button type="submit">{% trans "Login" %}</button>
    <div id="login-response" class="response"></div>
  </form>

  <section>
    <h2>{% trans "Profile" %}</h2>
    <button onclick="getProfile()">{% trans "Get Profile" %}</button>
    <div id="profile-response" class="response"></div>
  </section>

  <form onsubmit="updateProfile(event)">
    <h2>{% trans "Update Profile" %}</h2>
    <input id="upd-first" placeholder="{% trans "First name" %}">
    <input id="upd-lang" placeholder="{% trans "Preferred language (fa/en)" %}">
    <button type="submit">{% trans "Update" %}</button>
    <div id="update-response" class="response"></div>
  </form>

  <section>
    <h2>{% trans "Logout" %}</h2>
    <button onclick="logoutUser()">{% trans "Logout" %}</button>
    <div id="logout-response" class="response"></div>
  </section>
</body>
</html>
